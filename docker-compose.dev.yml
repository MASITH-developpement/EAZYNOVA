version: '3.8'

services:
  # Base de données PostgreSQL
  db:
    image: postgres:15-alpine
    container_name: eazynova_test_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-eazynova_test}
      POSTGRES_USER: ${POSTGRES_USER:-odoo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-odoo_password_2024}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - eazynova-test-db-data:/var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - eazynova-test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-odoo}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Application Odoo 19 avec EAZYNOVA
  odoo:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: eazynova_test_odoo
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "${ODOO_PORT:-8069}:8069"
      - "${ODOO_LONGPOLLING_PORT:-8072}:8072"
    environment:
      # Base de données
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER:-odoo}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-odoo_password_2024}
      - DB_NAME=${ODOO_DB_NAME:-eazynova_test}
      # PostgreSQL
      - PGHOST=db
      - PGPORT=5432
      - PGUSER=${POSTGRES_USER:-odoo}
      - PGPASSWORD=${POSTGRES_PASSWORD:-odoo_password_2024}
      - PGDATABASE=${ODOO_DB_NAME:-eazynova_test}
      # Odoo
      - PORT=8069
      - ADMIN_PASSWORD=${ODOO_ADMIN_PASSWORD:-admin}
      # Développement
      - ODOO_DEV_MODE=${ODOO_DEV_MODE:-True}
      - WATCHDOG_ENABLE=${WATCHDOG_ENABLE:-True}
    volumes:
      # Modules personnalisés (mode développement avec hot-reload)
      - ./addons/addons-perso:/opt/odoo/custom_addons:rw
      # Configuration Odoo
      - ./odoo.conf.dev:/etc/odoo/odoo.conf:ro
      # Données Odoo (filestore)
      - eazynova-test-data:/var/lib/odoo
      # Logs pour debug
      - ./logs:/var/log/odoo:rw
    networks:
      - eazynova-test-network
    command: /start-odoo.sh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8069/web/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PgAdmin (Interface pour gérer PostgreSQL)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: eazynova_test_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@eazynova.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - eazynova-test-pgadmin-data:/var/lib/pgadmin
    networks:
      - eazynova-test-network
    depends_on:
      - db

  # Mailhog (Serveur SMTP de test pour capturer les emails)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: eazynova_test_mailhog
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"  # SMTP
      - "${MAILHOG_WEB_PORT:-8025}:8025"    # Web UI
    networks:
      - eazynova-test-network

# Volumes persistants
volumes:
  eazynova-test-db-data:
    driver: local
  eazynova-test-data:
    driver: local
  eazynova-test-pgadmin-data:
    driver: local

# Réseau interne
networks:
  eazynova-test-network:
    driver: bridge
